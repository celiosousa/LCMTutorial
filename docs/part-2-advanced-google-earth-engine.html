<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 2 Part 2 - Advanced Google Earth Engine | Supervised Classification with Google Earth Engine</title>
  <meta name="description" content="Chapter 2 Part 2 - Advanced Google Earth Engine | Supervised Classification with Google Earth Engine" />
  <meta name="generator" content="bookdown 0.22 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 2 Part 2 - Advanced Google Earth Engine | Supervised Classification with Google Earth Engine" />
  <meta property="og:type" content="book" />
  
  
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 2 Part 2 - Advanced Google Earth Engine | Supervised Classification with Google Earth Engine" />
  
  
  

<meta name="author" content="Celio Sousa (celio.h.resendedesousa@nasa.gov)" />


<meta name="date" content="2022-05-05" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="part-1-basics-fundamentals.html"/>
<link rel="next" href="part-3-country-specific-applications.html"/>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<link href="libs/anchor-sections-1.0.1/anchor-sections.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.0.1/anchor-sections.js"></script>


<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>


<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Classification Tutorial</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Introduction and overview</a></li>
<li class="chapter" data-level="1" data-path="part-1-basics-fundamentals.html"><a href="part-1-basics-fundamentals.html"><i class="fa fa-check"></i><b>1</b> Part 1 - Basics &amp; Fundamentals</a><ul>
<li class="chapter" data-level="1.1" data-path="part-1-basics-fundamentals.html"><a href="part-1-basics-fundamentals.html#programming-and-remote-sensing-basics"><i class="fa fa-check"></i><b>1.1</b> Programming and Remote Sensing Basics</a><ul>
<li class="chapter" data-level="1.1.1" data-path="part-1-basics-fundamentals.html"><a href="part-1-basics-fundamentals.html#remote-sensing-language"><i class="fa fa-check"></i><b>1.1.1</b> Remote Sensing Language</a></li>
<li class="chapter" data-level="1.1.2" data-path="part-1-basics-fundamentals.html"><a href="part-1-basics-fundamentals.html#google-earth-engines-application-programming-interface-api-and-java-script"><i class="fa fa-check"></i><b>1.1.2</b> Google Earth Engine's Application Programming Interface (API) and Java Script</a></li>
<li class="chapter" data-level="1.1.3" data-path="part-1-basics-fundamentals.html"><a href="part-1-basics-fundamentals.html#exploring-image-and-image-collection"><i class="fa fa-check"></i><b>1.1.3</b> Exploring Image and Image Collection</a></li>
</ul></li>
<li class="chapter" data-level="1.2" data-path="part-1-basics-fundamentals.html"><a href="part-1-basics-fundamentals.html#image-and-image-collection-manipulation"><i class="fa fa-check"></i><b>1.2</b> Image and Image Collection Manipulation</a><ul>
<li class="chapter" data-level="1.2.1" data-path="part-1-basics-fundamentals.html"><a href="part-1-basics-fundamentals.html#imMath"><i class="fa fa-check"></i><b>1.2.1</b> Image Math</a></li>
<li class="chapter" data-level="1.2.2" data-path="part-1-basics-fundamentals.html"><a href="part-1-basics-fundamentals.html#compositing-and-mosaicking-compositing-and-mosaicking"><i class="fa fa-check"></i><b>1.2.2</b> Compositing and Mosaicking {#Compositing and Mosaicking}</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="2" data-path="part-2-advanced-google-earth-engine.html"><a href="part-2-advanced-google-earth-engine.html"><i class="fa fa-check"></i><b>2</b> Part 2 - Advanced Google Earth Engine</a><ul>
<li class="chapter" data-level="2.1" data-path="part-2-advanced-google-earth-engine.html"><a href="part-2-advanced-google-earth-engine.html#advanced-image-manipulation-pre-classification"><i class="fa fa-check"></i><b>2.1</b> Advanced Image Manipulation: Pre-classification</a><ul>
<li class="chapter" data-level="2.1.1" data-path="part-2-advanced-google-earth-engine.html"><a href="part-2-advanced-google-earth-engine.html#cloud-and-cloud-shadow-masking"><i class="fa fa-check"></i><b>2.1.1</b> Cloud and cloud shadow masking</a></li>
<li class="chapter" data-level="2.1.2" data-path="part-2-advanced-google-earth-engine.html"><a href="part-2-advanced-google-earth-engine.html#spectral-indices"><i class="fa fa-check"></i><b>2.1.2</b> Spectral indices</a></li>
</ul></li>
<li class="chapter" data-level="2.2" data-path="part-2-advanced-google-earth-engine.html"><a href="part-2-advanced-google-earth-engine.html#supervised-classification-using-random-forest"><i class="fa fa-check"></i><b>2.2</b> Supervised Classification using Random Forest</a><ul>
<li class="chapter" data-level="2.2.1" data-path="part-2-advanced-google-earth-engine.html"><a href="part-2-advanced-google-earth-engine.html#example-1-land-cover-classification-of-greater-cairo-and-giza-area-egypt---year-2022"><i class="fa fa-check"></i><b>2.2.1</b> Example 1: Land cover classification of Greater Cairo and Giza area, Egypt - Year 2022</a></li>
<li class="chapter" data-level="2.2.2" data-path="part-2-advanced-google-earth-engine.html"><a href="part-2-advanced-google-earth-engine.html#map-to-map-change"><i class="fa fa-check"></i><b>2.2.2</b> Map-to-Map Change</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="part-2-advanced-google-earth-engine.html"><a href="part-2-advanced-google-earth-engine.html#post-classification-processing"><i class="fa fa-check"></i><b>2.3</b> Post-classification processing</a><ul>
<li class="chapter" data-level="2.3.1" data-path="part-2-advanced-google-earth-engine.html"><a href="part-2-advanced-google-earth-engine.html#re-classification"><i class="fa fa-check"></i><b>2.3.1</b> Re-classification</a></li>
<li class="chapter" data-level="2.3.2" data-path="part-2-advanced-google-earth-engine.html"><a href="part-2-advanced-google-earth-engine.html#map-spatial-smoothing"><i class="fa fa-check"></i><b>2.3.2</b> Map spatial smoothing</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="part-3-country-specific-applications.html"><a href="part-3-country-specific-applications.html"><i class="fa fa-check"></i><b>3</b> PART 3 - Country-specific Applications</a><ul>
<li class="chapter" data-level="3.1" data-path="part-3-country-specific-applications.html"><a href="part-3-country-specific-applications.html#liberia"><i class="fa fa-check"></i><b>3.1</b> Liberia</a><ul>
<li class="chapter" data-level="3.1.1" data-path="part-3-country-specific-applications.html"><a href="part-3-country-specific-applications.html#class-by-class-land-cover-mapping"><i class="fa fa-check"></i><b>3.1.1</b> Class-by-class land cover mapping</a></li>
<li class="chapter" data-level="3.1.2" data-path="part-3-country-specific-applications.html"><a href="part-3-country-specific-applications.html#multi-class-land-cover-mapping"><i class="fa fa-check"></i><b>3.1.2</b> Multi-class land cover mapping</a></li>
<li class="chapter" data-level="3.1.3" data-path="part-3-country-specific-applications.html"><a href="part-3-country-specific-applications.html#land-cover-to-ecosystems-a-map-merging-approach"><i class="fa fa-check"></i><b>3.1.3</b> Land cover to ecosystems: a map merging approach</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="part-3-country-specific-applications.html"><a href="part-3-country-specific-applications.html#guinea"><i class="fa fa-check"></i><b>3.2</b> Guinea</a><ul>
<li class="chapter" data-level="3.2.1" data-path="part-3-country-specific-applications.html"><a href="part-3-country-specific-applications.html#mangrove-mapping-in-guinea-west-africa"><i class="fa fa-check"></i><b>3.2.1</b> Mangrove mapping in Guinea, West Africa</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="part-4-ecosystem-accounting.html"><a href="part-4-ecosystem-accounting.html"><i class="fa fa-check"></i><b>4</b> Part 4 - Ecosystem Accounting</a><ul>
<li class="chapter" data-level="4.1" data-path="part-4-ecosystem-accounting.html"><a href="part-4-ecosystem-accounting.html#introduction-to-ecosystem-accounting"><i class="fa fa-check"></i><b>4.1</b> Introduction to Ecosystem Accounting</a><ul>
<li class="chapter" data-level="4.1.1" data-path="part-4-ecosystem-accounting.html"><a href="part-4-ecosystem-accounting.html#essentials"><i class="fa fa-check"></i><b>4.1.1</b> Essentials</a></li>
</ul></li>
<li class="chapter" data-level="4.2" data-path="part-4-ecosystem-accounting.html"><a href="part-4-ecosystem-accounting.html#introduction-to-ecosystem-extent-account"><i class="fa fa-check"></i><b>4.2</b> Introduction to Ecosystem Extent Account</a><ul>
<li class="chapter" data-level="4.2.1" data-path="part-4-ecosystem-accounting.html"><a href="part-4-ecosystem-accounting.html#essentials-1"><i class="fa fa-check"></i><b>4.2.1</b> Essentials</a></li>
</ul></li>
<li class="chapter" data-level="4.3" data-path="part-4-ecosystem-accounting.html"><a href="part-4-ecosystem-accounting.html#compiling-ecosystem-extent-account-tables"><i class="fa fa-check"></i><b>4.3</b> Compiling Ecosystem Extent Account Tables</a><ul>
<li class="chapter" data-level="4.3.1" data-path="part-4-ecosystem-accounting.html"><a href="part-4-ecosystem-accounting.html#essentials-2"><i class="fa fa-check"></i><b>4.3.1</b> Essentials</a></li>
</ul></li>
<li class="chapter" data-level="4.4" data-path="part-4-ecosystem-accounting.html"><a href="part-4-ecosystem-accounting.html#compiling-ecosystem-extent-account-tables-1"><i class="fa fa-check"></i><b>4.4</b> Compiling Ecosystem Extent Account Tables</a><ul>
<li class="chapter" data-level="4.4.1" data-path="part-4-ecosystem-accounting.html"><a href="part-4-ecosystem-accounting.html#essentials-3"><i class="fa fa-check"></i><b>4.4.1</b> Essentials</a></li>
</ul></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Supervised Classification with Google Earth Engine</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="part-2---advanced-google-earth-engine" class="section level1">
<h1><span class="header-section-number">Chapter 2</span> Part 2 - Advanced Google Earth Engine</h1>
<div id="advanced-image-manipulation-pre-classification" class="section level2">
<h2><span class="header-section-number">2.1</span> Advanced Image Manipulation: Pre-classification</h2>
<p>In this section we will provide functions and lines of code to assist the user to prepare, process and analyze Landsat 8 data for classification purposes.</p>
<div id="cloud-and-cloud-shadow-masking" class="section level3">
<h3><span class="header-section-number">2.1.1</span> Cloud and cloud shadow masking</h3>
<p>This sub-section demonstrates a way of masking clouds and cloud shadow pixels from Landsat 8 Surface Reflectance Collection 2 data based on file metadata. You may have noticed when exploring Landsat images in the <strong>Console</strong> tab that these images have a band called <code>QA_PIXEL</code> or <em>Quality Assessment</em> band. Briefly, this band contains values that represent bit-packed combinations of surface, atmospheric, and sensor conditions that can affect the overall usefulness of a given pixel. One of the many bits represented in this band is <em>cloud</em> (bit 3) and <em>cloud shadow</em> (bit 4):</p>
<div class="figure"><span id="fig:QA"></span>
<img src="images/PartII-QABand.png" alt="Landsat's Quality Assessment (QA) band." width="884" />
<p class="caption">
Figure 2.1: Landsat's Quality Assessment (QA) band.
</p>
</div>
<p>In essence, these values indicate which pixels might be affected by surface conditions such as cloud contamination. Therefore, this band can be used to construct filters to mask (or remove) pixels flagged as 'affected' by that condition. Here, we will provide a function for masking clouds and cloud shadow from Landsat 8 images based on the information stored in the <em>Quality Assessment</em> band. This function was created based on the documentation available for Landsat 8. Values for pixel bit and pixel band were found <a href="https://www.usgs.gov/core-science-systems/nli/landsat/landsat-collection-1-level-1-quality-assessment-band?qt-science_support_page_related_con=0#qt-science_support_page_related_con" target="_blank"><em>here.</em></a></p>
<p>The cloud masking function is as follows:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="cf">function</span> <span class="kw">maskClouds</span>(image) {
  var cloudShadowBitMask =<span class="st"> </span><span class="kw">ee.Number</span>(<span class="dv">2</span>)<span class="kw">.pow</span>(<span class="dv">3</span>)<span class="kw">.int</span>();
  var cloudsBitMask =<span class="st"> </span><span class="kw">ee.Number</span>(<span class="dv">2</span>)<span class="kw">.pow</span>(<span class="dv">4</span>)<span class="kw">.int</span>();
  var QA =<span class="st"> </span><span class="kw">image.select</span>(<span class="st">&#39;QA_PIXEL&#39;</span>);
  var mask =<span class="st"> </span><span class="kw">QA.bitwiseAnd</span>(cloudShadowBitMask)<span class="kw">.eq</span>(<span class="dv">0</span>)
      <span class="kw">.and</span>(<span class="kw">QA.bitwiseAnd</span>(cloudsBitMask)<span class="kw">.eq</span>(<span class="dv">0</span>));
  return <span class="kw">image.updateMask</span>(mask)<span class="kw">.divide</span>(<span class="dv">100000</span>)<span class="kw">.select</span>(<span class="st">&quot;SR_B[0-9]*&quot;</span>)<span class="kw">.copyProperties</span>(image, [<span class="st">&quot;system:time_start&quot;</span>]);
}</code></pre></div>
<p>Do not worry about the new methods within this function. What you need to know is that this function was constructed in a way that we are selecting the <code>QA_PIXEL</code> band from the Landsat image and creating a mask where only pixels flagged to 0 (indicating clear conditions) for bits 3 and 4 will be included; The function will return <code>image</code> - in this case the Landsat 8 image - masked for pixels that are not flagged 0 for bits 3 and 4. The <code>.divide()</code> was used simply to scale the band values to [0,1] and <code>.select()</code> to only select the spectral bands from Landsat (SR_B1-9). These steps are not necessary for the cloud masking to work! However, we can add these extra steps to further improve our image collection.</p>
<p>Now, to apply a function to every image in an image collection, we use the <code>.map()</code> method from the <code>ee.ImageCollection()</code> object. You can refer to the <strong>Docs</strong> tab for more information on the methods available for <code>ee.ImageCollection()</code>. The only argument to <code>map()</code> is a function which takes one single parameter: an <code>ee.Image()</code>. Using <code>.map(maskClouds)</code> over an image collection will result in a collection where every image is masked for clouds and cloud shadows.</p>
<p>To illustrate this, we will apply <code>maskClouds</code> over <code>collection</code> (created in the previous chapter) along with the same temporal and spatial filters to recreate <code>collectionFiltered</code>. Feel free to use your previous chapter's script and simply add <code>.map()</code> to the collections using the code below as an example:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">var collection =<span class="st"> </span><span class="kw">ee.ImageCollection</span>(<span class="st">&#39;LANDSAT/LC08/C02/T1_L2&#39;</span>);
var startDate =<span class="st"> &#39;2022-01-01&#39;</span>;
var endDate =<span class="st"> &#39;2022-04-30&#39;</span>;

var collectionFilteredMasked =<span class="st"> </span><span class="kw">collection.filterBounds</span>(aoi)
                                   <span class="kw">.filterDate</span>(startDate,endDate)
                                   <span class="kw">.map</span>(maskClouds);</code></pre></div>
<p>Now, we will create a max value composite and compare it to the previous composite created with an image collection that <strong>was not masked for clouds and cloud shadows</strong>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">var compositeMax =<span class="st"> </span><span class="kw">collectionFilteredMasked.max</span>();
<span class="kw">Map.addLayer</span>(compositeMax, {bands<span class="op">:</span><span class="st"> </span>[<span class="st">&#39;SR_B4&#39;</span>, <span class="st">&#39;SR_B3&#39;</span>, <span class="st">&#39;SR_B2&#39;</span>], min<span class="op">:</span><span class="dv">0</span>, max<span class="op">:</span><span class="fl">0.25</span>}, <span class="st">&#39;Composite Max Value&#39;</span>);</code></pre></div>
<div class="figure"><span id="fig:CompositesMasked"></span>
<img src="images/PartII-CompositesMasked.png" alt="A maximum value composite created with an image collection masked by clouds compared to a composite created using an unmasked collection." width="1264" />
<p class="caption">
Figure 2.2: A maximum value composite created with an image collection masked by clouds compared to a composite created using an unmasked collection.
</p>
</div>
<p>As mentioned in the previous chapter, a maximum value composite will likely highlight clouds as they are very reflective. However, by removing the cloud pixels from the images based on the Quality Assessment band information, the resulting maximum value composite greatly improves.</p>
</div>
<div id="spectral-indices" class="section level3">
<h3><span class="header-section-number">2.1.2</span> Spectral indices</h3>
<p>In the previous sub-section, we presented a function to mask cloud and cloud shadows from Landsat image collections. A function can also be created to perform band math to every image in an image collection. Building on the concepts of vegetation indices presented on the previous chapter, we will create a function that will calculate several vegetation indices for Landsat 8 images. You will recognize the NDVI and EVI indices from the previous chapters. This function includes other commonly used spectral indices to highlight features like open water, moisture, vegetation and soil:</p>
<ul>
<li>NDVI - Normalized Difference Vegetation Index;</li>
<li>NBR - Normalized Burn Ratio;</li>
<li>NDMI - Normalized Difference Mangrove Index;</li>
<li>MNDWI - Modified Normalized Difference Water Index;</li>
<li>SR - Simple Ratio;</li>
<li>BI - Bare soil Index;</li>
<li>GCVI - Green Chlorophyll Vegetation Index;</li>
<li>EVI - Enhanced Vegetation Index, and;</li>
<li>MSAVI - Modified Soil-Adjusted Vegetation Index.</li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="cf">function</span> <span class="kw">addIndices</span>(image) {
  var ndvi =<span class="st"> </span><span class="kw">image.normalizedDifference</span>([<span class="st">&#39;SR_B5&#39;</span>,<span class="st">&#39;SR_B4&#39;</span>])<span class="kw">.rename</span>(<span class="st">&#39;NDVI&#39;</span>);
  var nbr =<span class="st"> </span><span class="kw">image.normalizedDifference</span>([<span class="st">&#39;SR_B5&#39;</span>,<span class="st">&#39;SR_B7&#39;</span>])<span class="kw">.rename</span>(<span class="st">&#39;NBR&#39;</span>);
  var ndmi =<span class="st"> </span><span class="kw">image.normalizedDifference</span>([<span class="st">&#39;SR_B7&#39;</span>,<span class="st">&#39;SR_B3&#39;</span>])<span class="kw">.rename</span>(<span class="st">&#39;NDMI&#39;</span>);
  var mndwi =<span class="st"> </span><span class="kw">image.normalizedDifference</span>([<span class="st">&#39;SR_B3&#39;</span>,<span class="st">&#39;SR_B6&#39;</span>])<span class="kw">.rename</span>(<span class="st">&#39;MNDWI&#39;</span>);
  var sr =<span class="st"> </span><span class="kw">image.select</span>(<span class="st">&#39;SR_B5&#39;</span>)<span class="kw">.divide</span>(<span class="kw">image.select</span>(<span class="st">&#39;SR_B4&#39;</span>))<span class="kw">.rename</span>(<span class="st">&#39;SR&#39;</span>);
  var bare =<span class="st"> </span><span class="kw">image.normalizedDifference</span>([<span class="st">&#39;SR_B6&#39;</span>,<span class="st">&#39;SR_B7&#39;</span>])<span class="kw">.rename</span>(<span class="st">&#39;BI&#39;</span>);
  var gcvi =<span class="st"> </span><span class="kw">image.expression</span>(<span class="st">&#39;(NIR/GREEN)-1&#39;</span>,{
    <span class="st">&#39;NIR&#39;</span><span class="op">:</span><span class="kw">image.select</span>(<span class="st">&#39;SR_B5&#39;</span>),
    <span class="st">&#39;GREEN&#39;</span><span class="op">:</span><span class="kw">image.select</span>(<span class="st">&#39;SR_B3&#39;</span>)
  })<span class="kw">.rename</span>(<span class="st">&#39;GCVI&#39;</span>);
  var evi =<span class="st"> </span><span class="kw">image.expression</span>(
  <span class="st">&#39;2.5 * ((NIR-RED) / (NIR + 6 * RED - 7.5* SR_BLUE +1))&#39;</span>, {
    <span class="st">&#39;NIR&#39;</span><span class="op">:</span><span class="kw">image.select</span>(<span class="st">&#39;SR_B5&#39;</span>),
    <span class="st">&#39;RED&#39;</span><span class="op">:</span><span class="kw">image.select</span>(<span class="st">&#39;SR_B4&#39;</span>),
    <span class="st">&#39;SR_BLUE&#39;</span><span class="op">:</span><span class="kw">image.select</span>(<span class="st">&#39;SR_B2&#39;</span>)
  })<span class="kw">.rename</span>(<span class="st">&#39;EVI&#39;</span>);
  var msavi =<span class="st"> </span><span class="kw">image.expression</span>(
  <span class="st">&#39;(2 * NIR + 1 - sqrt(pow((2 * NIR + 1), 2) - 8 * (NIR - RED)) ) / 2&#39;</span>, {
    <span class="st">&#39;NIR&#39;</span><span class="op">:</span><span class="st"> </span><span class="kw">image.select</span>(<span class="st">&#39;SR_B5&#39;</span>), 
    <span class="st">&#39;RED&#39;</span><span class="op">:</span><span class="st"> </span><span class="kw">image.select</span>(<span class="st">&#39;SR_B4&#39;</span>)}
)<span class="kw">.rename</span>(<span class="st">&#39;MSAVI&#39;</span>);
    return image
    <span class="kw">.addBands</span>(ndvi)
    <span class="kw">.addBands</span>(nbr)
    <span class="kw">.addBands</span>(ndmi)
    <span class="kw">.addBands</span>(mndwi)
    <span class="kw">.addBands</span>(sr)
    <span class="kw">.addBands</span>(evi)
    <span class="kw">.addBands</span>(msavi)
    <span class="kw">.addBands</span>(gcvi)
    <span class="kw">.addBands</span>(bare);
}</code></pre></div>
<p>The <code>.addBands()</code> method is used to include an <code>ee.Image()</code> as a band to an existing image. Therefore, this function will calculate each index and include them as extra bands to every image in the image collection.</p>
<p>As in the previous sub-section, we can use <code>.map()</code> to map this function over <code>collection</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">var collectionFilteredwithIndex =<span class="st"> </span><span class="kw">collection.filterBounds</span>(aoi)
                                   <span class="kw">.filterDate</span>(startDate,endDate)
                                   <span class="kw">.map</span>(maskClouds)
                                   <span class="kw">.map</span> (addIndices);</code></pre></div>
<p>Then we will create median composite based on this new collection. We will add it to the <strong>Map Editor</strong> and will use the <strong>Inspector</strong> tab to explore its band values at a given location:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">var compositeMedian =<span class="st"> </span><span class="kw">collectionFilteredwithIndex.median</span>();
<span class="kw">Map.addLayer</span>(compositeMedian, {bands<span class="op">:</span><span class="st"> </span>[<span class="st">&#39;SR_B4&#39;</span>, <span class="st">&#39;SR_B3&#39;</span>, <span class="st">&#39;SR_B2&#39;</span>], min<span class="op">:</span><span class="dv">0</span>, max<span class="op">:</span><span class="fl">0.25</span>}, <span class="st">&#39;Composite Median&#39;</span>);</code></pre></div>
<p>You can toggle the data view from chart to values with the chart/value view button:</p>
<div class="figure"><span id="fig:VIS"></span>
<img src="images/PartII-VIS.png" alt="A median composite created from the `collectionFilteredwithIndex` image collection. The function `addIndices` was used to calculate each index and add them as separate bands to every image in the collection. In this example, the spectral bands and spectral index values for a pixel at an arbitrary location within `compositeMedian`. You can toggle between the chart view and value view using the chart button (red circle)." width="614" />
<p class="caption">
Figure 2.3: A median composite created from the <code>collectionFilteredwithIndex</code> image collection. The function <code>addIndices</code> was used to calculate each index and add them as separate bands to every image in the collection. In this example, the spectral bands and spectral index values for a pixel at an arbitrary location within <code>compositeMedian</code>. You can toggle between the chart view and value view using the chart button (red circle).
</p>
</div>
</div>
</div>
<div id="supervised-classification-using-random-forest" class="section level2">
<h2><span class="header-section-number">2.2</span> Supervised Classification using Random Forest</h2>
<p>As seen in Part I, Interpretation and Analysis is one of the building blocks of any remote sensing system (see <a href="part-1-basics-fundamentals.html#fig:FigBuildingBlocks">1.1</a>). Image classification is one of the many methods of image processing and it is the sole focus of this training material. So far, you have learned the basics of Java Script and Google Earth Engine and some pre-processing steps to perform an image classification using the Random Forest (RF) Classifier. Briefly, classifier is an ensemble of classification trees, where each tree contributes with a single vote for the assignment of the most frequent class to the input data. Different from Decision Trees, which use the best predictive variables at the split, RF uses a random subset of the predictive variables. The RF is one of the most used and robust classifiers and it is fully implemented in GEE. In the following examples we will present the steps for land cover classification using the RF classifier and present some basic analysis that can be done using the classification output.</p>
<div id="example-1-land-cover-classification-of-greater-cairo-and-giza-area-egypt---year-2022" class="section level3">
<h3><span class="header-section-number">2.2.1</span> Example 1: Land cover classification of Greater Cairo and Giza area, Egypt - Year 2022</h3>
<p>The general steps for an image classification process with Landsat image is:</p>
<ol style="list-style-type: lower-alpha">
<li><p>To use a cloud-masking function to mask clouds on Landsat 8 Imagery;</p></li>
<li><p>To calculate spectral indices that will be used as predictors for the Random Forest;</p></li>
<li><p>To produce a cloud-free composite mosaic using the median reducer, and;</p></li>
<li><p>To select training samples;</p></li>
<li><p>To classify the cloud-free composite mosaic of Landsat 8 scenes using Random Forest.</p></li>
</ol>
<p>In this example we will classify the median composite (<code>compositeMedian</code>) created in the previous section. You can find the code for creating it <a href="https://code.earthengine.google.com/f6d329bb7a6dcec10609c118e0af57e7" target="_blank">here.</a></p>
<div class="rmdcomment">
<p>
You have the option to classify the entire scene or clip it to an area of interest. You can create a geometry <code>AreaOfInterest</code> and clip your composite using <code>.clip(AreaOfInterest)</code>. You can also customize the composite visualization parameters by clicking on the settings icon (gear ⚙) next to the layer name (in this example: 'Composite Median')
</p>
</div>
<p>So far, we have covered the steps <em><strong>a</strong></em>, <em><strong>b</strong></em> and <em><strong>c</strong></em>.</p>
<ul>
<li><strong>Training sample selection</strong></li>
</ul>
<p>For this example, let’s classify the 'composite' into four classes: <em>water</em>, <em>agricultural land</em>, <em>sand and bare areas</em> and <em>urbanization</em>. The first step is to create the training samples set to use into the Random Forest Model.</p>
<p><strong>Step 1</strong> - In the Geometry Imports, click <em><strong>+new layer</strong></em> and make four sets of geometries, each set will represent samples from the classes 'water', 'cropland', 'sand' and 'urban'.</p>
<div class="figure"><span id="fig:my-figGeom"></span>
<img src="images/Geometries.PNG" alt="Geometry sets to hold samples for each of the four classes." width="1550" />
<p class="caption">
Figure 2.4: Geometry sets to hold samples for each of the four classes.
</p>
</div>
<p><strong>Step 2</strong> - For each geometry in the list, click on the settings icon⚙: name them accordingly using the 'Name' box, choose a color for it using the color picker and import each geometry as <em>FeatureCollection</em>. Add a property called <em>landcover</em> by clicking on the <em><strong>+ Property</strong></em> and set a consecutive integer starting from 0 or 1 for each of the classes. You should achieve something similar to this:</p>
<div class="figure"><span id="fig:my-figGeom2"></span>
<img src="images/Geometries2.PNG" alt="Geometries used to create the training sample sets." width="830" />
<p class="caption">
Figure 2.5: Geometries used to create the training sample sets.
</p>
</div>
<p>Your Geometry Imports should look like this:</p>
<div class="figure"><span id="fig:my-figGeom3"></span>
<img src="images/Geo3.PNG" alt="Geometry Imports after creating geometry sets to hold training samples" width="994" />
<p class="caption">
Figure 2.6: Geometry Imports after creating geometry sets to hold training samples
</p>
</div>
<p>Start selecting samples by clicking on the ‘Water’ geometry in the Geometry Imports. Choose the point drawing tool and place some points along the River Nile:</p>
<div class="starcomment">
<p>
Take advantage of the high resolution imagery to help you select samples for each class. You can toggle in between map and Google Earth imagery by using the buttons <em><strong>Map</strong></em> and <em><strong>Satellite</strong></em> in the upper right corner of the Map Editor. You can also toggle the Landsat composite ON and OFF by using the layer manager.
</p>
</div>
<p>Instead of single points (i.e pixels), we can also use polygons containing a variable number of relatively homogenous pixels of a given land cover class. Switch to the polygon drawing tool and draw a few polygons over the River Nile:</p>
<div class="figure"><span id="fig:my-figNile"></span>
<img src="images/Nile.PNG" alt="Sample points and polygons for the Water class" width="1152" />
<p class="caption">
Figure 2.7: Sample points and polygons for the Water class
</p>
</div>
<div class="starcomment">
<p>
Once you finish selecting samples, click the <em><strong>Exit</strong></em> button on the polygon editor dialogue box . Repeat the process for each of the other class. Make sure you select samples that are representative of each land cover class by selecting points and polygons of homogenous pixels.
</p>
</div>
<div class="figure"><span id="fig:my-figAllSamples"></span>
<img src="images/AllSamples.PNG" alt="Example of sample points and polygons for ‘Water’ (blue), ‘Cropland’ (yellow), ‘Urban’ (red) and ‘Sand’ (pink). Each pixel within the polygons will be used as training inputs for the RF classifier." width="1370" />
<p class="caption">
Figure 2.8: Example of sample points and polygons for ‘Water’ (blue), ‘Cropland’ (yellow), ‘Urban’ (red) and ‘Sand’ (pink). Each pixel within the polygons will be used as training inputs for the RF classifier.
</p>
</div>
<p>After selecting the samples, we will merge all the geometries together into an object var classes using the <code>.merge</code> method of the <code>ee.FeatureCollection() object</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">var classes =<span class="st"> </span><span class="kw">Water.merge</span>(Cropland)
                   <span class="kw">.merge</span>(Sand)
                   <span class="kw">.merge</span>(Urban);</code></pre></div>
<p><a href="https://code.earthengine.google.com/0666bce96ffb1bd350cfc738f7b2aeab" target="_blank">Code Checkpoint</a></p>
<ul>
<li><strong>Sample sets</strong></li>
</ul>
<p>In this section, we will create the training (and testing) sample sets to be used in the classification with Random Forest. First, we will select the predictors to assign to each sample point in the sample sets. For this example, we will create a list <code>var bands</code> with the names of three spectral bands (<code>'SR_B4'</code>,<code>'SR_B5'</code>,<code>'SR_B6'</code>) and the spectral indices (<code>'NDVI'</code>,<code>'NBR'</code>,<code>'MNDWI'</code>,<code>'SR'</code>,<code>'GCVI'</code> and <code>'MSAVI'</code>).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">var bands =<span class="st"> </span>[<span class="st">&#39;B4&#39;</span>,<span class="st">&#39;B5&#39;</span>,<span class="st">&#39;B6&#39;</span>,<span class="st">&#39;NDVI&#39;</span>,<span class="st">&#39;NBR&#39;</span>,<span class="st">&#39;MNDWI&#39;</span>,<span class="st">&#39;SR&#39;</span>,<span class="st">&#39;GCVI&#39;</span>,<span class="st">&#39;MSAVI&#39;</span>];</code></pre></div>
<p>Next, we will sample the Landsat pixels by overlaying the geometries with the composite using <code>.sampleRegions()</code>. The main arguments of this method is the image to sample (in this case, <code>compositeMedian</code>), the regions to sample over (in this case, <code>classes</code>) and the list of properties to copy from each geometry (in this case <strong>landcover</strong>):</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">var samples =<span class="st"> </span><span class="kw">compositeMedian.select</span>(bands)<span class="kw">.sampleRegions</span>({
  collection<span class="op">:</span><span class="st"> </span>classes,       
  properties<span class="op">:</span><span class="st"> </span>[<span class="st">&#39;landcover&#39;</span>],
  scale<span class="op">:</span><span class="st"> </span><span class="dv">30</span>                  
})<span class="kw">.randomColumn</span>(<span class="st">&#39;random&#39;</span>);</code></pre></div>
<p>In the <code>samples</code> object we have just created, each sample will include a column with the values from the list <code>bands</code> inherited from the <code>compositeMedian</code> and a column with their respective class label. Optionally, you can perform an accuracy assessment of the classifier by taking advantage of the identifiers assigned to the samples by the <code>.randomColumn('random')</code> within <code>samples</code>. This method adds a column to the feature collection populated with random numbers in the range of 0 to 1. For this example, we will randomly partition the sample set into <code>training</code> (80% of the samples) and <code>testing</code> (20% of the samples) samples by filtering the samples by its random number column using the lower (<code>.lt</code>) and greater than or equal (<code>.gte</code>) filters:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">var split =<span class="st"> </span><span class="fl">0.8</span>;
var training =<span class="st"> </span><span class="kw">samples.filter</span>(<span class="kw">ee.Filter.lt</span>(<span class="st">&#39;random&#39;</span>, split));
var testing =<span class="st"> </span><span class="kw">samples.filter</span>(<span class="kw">ee.Filter.gte</span>(<span class="st">&#39;random&#39;</span>, split));</code></pre></div>
<p>For your information, you can inspect the size of a <code>ee.FeatureCollection</code> using the <code>.aggregate_count()</code> method. This method only takes a property of the feature collection being counted as its argument. In this case, we have a property called 'landcover' in our feature collection. <code>.aggregate_count()</code> It is a useful tool to extract the number of features on your sample set:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">print</span>(<span class="st">&#39;Samples n =&#39;</span>, <span class="kw">samples.aggregate_count</span>(<span class="st">&#39;landcover&#39;</span>));
<span class="kw">print</span>(<span class="st">&#39;Training n =&#39;</span>, <span class="kw">training.aggregate_count</span>(<span class="st">&#39;landcover&#39;</span>));
<span class="kw">print</span>(<span class="st">&#39;Testing n =&#39;</span>, <span class="kw">testing.aggregate_count</span>(<span class="st">&#39;landcover&#39;</span>));</code></pre></div>
<div class="rmdcomment">
<p>
If a feature collection do not have a property defined, you can still count its feature by using <code>'.all'</code> as an argument for <code>.aggregate_count()</code>
</p>
</div>
<p>Using the split value above, roughtly 80% of the features in <code>samples</code> will be <code>training</code> and 20% will be in <code>testing</code>:</p>
<div class="figure"><span id="fig:my-fig39"></span>
<img src="images/Figure39.PNG" alt="Sample sets size for this example. Note that the number will vary based on the number of geometries (polygons and points) and the sample split value." width="628" />
<p class="caption">
Figure 2.9: Sample sets size for this example. Note that the number will vary based on the number of geometries (polygons and points) and the sample split value.
</p>
</div>
</div>
<div id="map-to-map-change" class="section level3">
<h3><span class="header-section-number">2.2.2</span> Map-to-Map Change</h3>
</div>
</div>
<div id="post-classification-processing" class="section level2">
<h2><span class="header-section-number">2.3</span> Post-classification processing</h2>
<div id="re-classification" class="section level3">
<h3><span class="header-section-number">2.3.1</span> Re-classification</h3>
</div>
<div id="map-spatial-smoothing" class="section level3">
<h3><span class="header-section-number">2.3.2</span> Map spatial smoothing</h3>

</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="part-1-basics-fundamentals.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="part-3-country-specific-applications.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/celiosousa/LCMTutorial/edit/master/02-PART_II.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": "https://github.com/celiosousa/LCMTutorial/blob/master/02-PART_II.Rmd",
"text": null
},
"download": null,
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
